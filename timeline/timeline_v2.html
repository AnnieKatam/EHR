<!DOCTYPE html>
<html>
<head lang="en">
	<title> Timeline </title>
	<meta charset="utf-8">
	<script type="text/javascript" src="./d3.v3.min.js"></script>
	<style type"text/css">
	body {
		font: 300 16px "Helvetica Neue";
		height: 640px;
		margin: 80px 160px 80px 160px;
		position: relative;
		width: 960px;
	}
	
	.axis{
		shape-rendering: crispEdges;
	}
	
	.axis path, .axis line{
		fill: none;
	}
	
	
	.x.axis line{
		stroke: #ddd;
		stroke-opacity: .5
	}
	

	</style>
</head>
<body>
	<div id="chart"></div>
	<script>
		function renderTimeLine(){
		var group;
			
		var m = [80, 160, 0, 160]; // top right bottom left
		var	w = 1200 - m[1] - m[3]; // width
		var h = 700 - m[0] - m[2]; // height
		var barLabelWidth=120;
		var barLabelPadding=5;
		var gridLabelHeight=18;
		var gridChartOffset=3;
		
		
			var data = [{"label": "chlorthalidone", "dates":[{"startdate": new Date(2007,9,01), "enddate": Date.now(), "strength": 16, "dosage": 25}]},
			{"label": "metformin", "dates":[{"startdate": new Date(2008,7,27), "enddate": new Date(2009,1,27), "strength": 1, "dosage": 500}, {"startdate":new Date(2009,1,28), "enddate": new Date(2011,8,07), "strength": 16, "dosage": 1000 }]},
			{"label": "citalopram", "dates":[{"startdate": new Date(2008,7,27), "enddate": new Date(2008,10,24), "strength": 1, "dosage": 10}, {"startdate": new Date(2008,10,25), "enddate": new Date(2008,12,23), "strength": 8, "dosage": 20}, {"startdate":new Date(2008,12,24), "enddate": new Date(2009,6,21), "strength": 16, "dosage": 40}, {"startdate": new Date(2009,6,22), "enddate": new Date(2010,3,18), "strength": 8, "dosage": 20}]},
			{"label": "clonazepam", "dates": [{"startdate": new Date(2008,11,02), "enddate": new Date(2009,3,31), "strength": 1, "dosage": 0.5}]},
			{"label": "trazodone", "dates": [{"startdate": new Date(2009,4,02), "enddate": new Date(2009,5,30), "strength": 1, "dosage": 50}, {"startdate": new Date(2009,6,01), "enddate": new Date(2009,11,26), "strength": 16, "dosage": 100}, {"startdate": new Date(2009,11,27), "enddate": new Date(2010,3,26), "strength": 1, "dosage": 50}, {"startdate": new Date(2010,7,25), "enddate": new Date(2011,8,18), "strength": 1, "dosage": 50}]},
			{"label": "zolpidem", "dates":[{"startdate": new Date(2010,3,27), "enddate": new Date(2010,7,24), "strength": 1, "dosage": 10}]},
			{"label": "lisonopril", "dates":[{"startdate": new Date(2010,7,24), "enddate": new Date(2011,3,20), "strength": 1, "dosage": 10}, {"startdate": new Date(2011,3,21), "enddate": Date.now(), "strength": 16, "dosage": 20}]},
			{"label": "naproxen", "dates":[{"startdate": new Date(2008,3,13), "enddate": new Date(2014,9,06), "strength": 1, "dosage": 500}]}
			];
			
			
			var x=d3.time.scale().range([75, w+200]);
			
			var minDate=new Date(2006,1,01);
			var maxDate=new Date(2016,1,01);
			
			var chartStart=100;
			
			
			x.domain([minDate, maxDate]);				
			
			var y=d3.scale.linear().domain([0, data.length]).range([chartStart, h]);
			
			
			var chart=d3.select('#chart').append("svg")
					.classed("chart", true)
					.attr("width", w+m[1]+m[3])
					.attr("height",h+m[0]+m[2])
					.call(d3.behavior.zoom().x(x).on("zoom", zoom).scaleExtent([0, 10]));
						
							
			var xaxis=d3.svg.axis()
					.scale(x)
					.orient("top")
					.tickSize(h-50)
					.tickPadding(0);
					
			chart.append('g')
				.attr("class", "x axis")
				.attr("transform", "translate(0, "+ h + ")");
				
				
					
				
		var timeBars=chart.selectAll(".medicineGroup").data(data).enter().append('g').classed("medicineGroup", true)
							.attr('transform', function(d, i){ return 'translate(0, '+ (y(i)) +')' }) ;
							
		function updateBars(){
			timeBars.each(function(d, i){
				console.log(d);
		 		group=d3.select(this);
		 		
		 		group.select(".barGroup").selectAll(".timeBars").each(function(d){
		 			d3.select(this)
		 			.attr("x", function(d){ return x(d.startdate);})
				.attr("width", function(d){ return x(d.enddate)-x(d.startdate);})
				
		 		});
		 		
		 		group.select(".barGroup").selectAll(".timeBarstext").each(function(d){
		 			d3.select(this).attr("x", function(d){return x(d.startdate)+(x(d.enddate)-x(d.startdate))/2;})
		 		});
		 			
		 	});
		}	
		
						
		timeBars.each(function(d, i){
			console.log(d);
		 group=d3.select(this);
		 
		 var barGroup = group.append("g").classed("barGroup", true);
		 
		barGroup.selectAll(".timeBars")
				.data(d.dates)
				.enter()
				.append("rect")
				.classed("timeBars", true)
				.attr("y", function(d){return -(d.strength*3-5)/2;})
				.attr("height", function(d){return d.strength * 3 + 10;})
				.attr("stroke", "white")
				.attr("fill", function(d){
					if(d.strength<8){
						return "lightgrey";
					}else if(d.strength>=8 && d.strength<16){
						return "grey";
					}else{
						return "black";
					}
				});
				
				barGroup.selectAll(".timeBarstext")
					.data(d.dates)
					.enter()
					.append("text")
					.classed("timeBarstext", true)
					.attr("y", function(d){return ((-(d.strength*3-5)/2) + (d.strength*3+10)/2) + 4;})
					.attr("fill", "red")
					.attr("text-anchor", "middle")
					.attr("font-size", "11px")
					.text(function(d){return d.dosage;});
				
			group.append("rect")
				.attr("x", 0)
				.attr("y", -50)
				.attr("width", 150)
				.attr("height", h)
				.attr("stroke", "white")
				.attr("fill", "white");
			
			group.append("text")
				.attr("y", 10)
				.attr("height", 20)
				.attr("stroke", "none")
				.attr("fill", "black")
				.attr("text-anchor", "start")
				.attr("dominant-baseline", "middle")
				.text(d.label);
						
		});
		
		function zoom(){
				chart.select("g.x.axis").call(xaxis);
				updateBars();
			};
			zoom();
	
	}
	</script>
	
	<script> renderTimeLine(); </script>
</body>
</html>

