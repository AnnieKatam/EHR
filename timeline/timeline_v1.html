<!DOCTYPE html>
<html>
<head lang="en">
	<title> Timeline </title>
	<meta charset="utf-8">
	<script type="text/javascript" src="./d3.v3.min.js"></script>
	<style type"text/css">
	body {
		font: 300 16px "Helvetica Neue";
		height: 640px;
		margin: 80px 160px 80px 160px;
		overflow: hidden;
		position: relative;
		width: 960px;
	}
	</style>
</head>
<body>
	<div id="chart"></div>
	<script>
		function renderTimeLine(){
			
		var m = [80, 160, 0, 160]; // top right bottom left
		var	w = 1200 - m[1] - m[3]; // width
		var h = 700 - m[0] - m[2]; // height
		var barLabelWidth=120;
		var barLabelPadding=5;
		var gridLabelHeight=18;
		var gridChartOffset=3;
		

		
			var data = [{"label": "chlorthalidone", "dates":[{"startdate": new Date(2007,9,01), "enddate": Date.now(), "strength": 16}]},
			{"label": "metformin", "dates":[{"startdate": new Date(2008,7,27), "enddate": new Date(2009,1,27), "strength": 1}, {"startdate":new Date(2009,1,28), "enddate": new Date(2011,8,07), 
			"strength": 16 }]},
			{"label": "citalopram", "dates":[{"startdate": new Date(2008,7,27), "enddate": new Date(2008,10,24), "strength": 1}, {"startdate": new Date(2008,10,25), "enddate": new Date(2008,12,23), "strength": 8}, {"startdate":new Date(2008,12,24), "enddate": new Date(2009,6,21), "strength": 16}, {"startdate": new Date(2009,6,22), "enddate": new Date(2010,3,18), "strength": 8}]},
			{"label": "clonazepam", "dates": [{"startdate": new Date(2008,11,02), "enddate": new Date(2009,3,31), "strength": 1}]},
			{"label": "trazodone", "dates": [{"startdate": new Date(2009,4,02), "enddate": new Date(2009,5,30), "strength": 1}, {"startdate": new Date(2009,6,01), "enddate": new Date(2009,11,26), "strength": 16}, {"startdate": new Date(2009,11,27), "enddate": new Date(2010,3,26), "strength": 1}, {"startdate": new Date(2010,7,25), "enddate": new Date(2011,8,18), "strength": 1}]},
			{"label": "zolpidem", "dates":[{"startdate": new Date(2010,3,27), "enddate": new Date(2010,7,24), "strength": 1}]},
			{"label": "lisonopril", "dates":[{"startdate": new Date(2010,7,24), "enddate": new Date(2011,3,20), "strength": 1}, {"startdate": new Date(2011,3,21), "enddate": Date.now(), "strength": 16}]},
			{"label": "naproxen", "dates":[{"startdate": new Date(2008,3,13), "enddate": new Date(2014,9,06), "strength": 1}]}
			];
			
			
			var parseDate=d3.time.format("%Y-%m-%d").parse;
			var dosage=[0.5, 10, 20, 25, 40, 50, 100, 500, 1000];
						
			var x=d3.time.scale().range([80, w]);
			
			var minDate=new Date(2006,1,01);
			var maxDate=new Date(2016,12,31);
			
			var chartStart=100;
			
			
			x.domain([minDate, maxDate]);				
			
			var yscale=d3.scale.linear().domain([0, data.length]).range([chartStart, h]);
			
			
			var chart=d3.select('#chart').append("svg")
					.attr("width", w+m[1]+m[3])
					.attr("height",h+m[0]+m[2]);
									
			chart.selectAll(".tickline").data(x.ticks(10))
						.enter().append("line")
						.classed("tickline", true)
						.attr("x1", x)
						.attr("x2", x)
						.attr("y1", 10)
						.attr("y2", h)
						.style("stroke", "#ccc");
						
			var xaxis=d3.svg.axis()
					.scale(x)
					.orient("bottom")
					.ticks(d3.time.years, 1)
					.tickFormat(d3.time.format("%Y"))
					.tickSize(0);
					
			chart.append('g')
				.attr("class", 'xaxis')
				.call(xaxis);
					
				
		var timeBars=chart.selectAll(".medicineGroup").data(data).enter().append('g').classed("medicineGroup", true)
							.attr('transform', function(d, i){ return 'translate(0, '+ (yscale(i)) +')' }) ;
							
		timeBars.each(function(d, i){
			console.log(d);
			var group=d3.select(this);
			group.append("text")
				.attr("y", 10)
				.attr("height", 20)
				.attr("stroke", "none")
				.attr("fill", "black")
				.attr("text-anchor", "start")
				.attr("dominant-baseline", "middle")
				.text(d.label);
		
				group.selectAll(".timeBars")
				.data(d.dates)
				.enter()
				.append("rect")
				.attr("x", function(d){ return x(d.startdate);})
				.attr("y", 0)
				.attr("width", function(d){ return x(d.enddate)-x(d.startdate);})
				.attr("height", function(d){return d.strength * 3 + 10;})
				.attr("stroke", "white")
				.attr("fill", function(d){
					if(d.strength<8){
						return "lightgrey";
					}else if(d.strength>=8 && d.strength<16){
						return "grey";
					}else{
						return "black";
					}
				});

			})	

		}
	</script>
	
	<script> renderTimeLine(); </script>
</body>
</html>

