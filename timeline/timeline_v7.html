<!DOCTYPE html>
<html>
<head lang="en">
	<title> Timeline </title>
	<meta charset="utf-8">
	<script type="text/javascript" src="./d3.v3.min.js"></script>
	<!-- <script type="text/javascript" src="https://github.com/mbostock/d3/blob/master/src/behavior/zoom.js"></script> -->
	<style type"text/css">
	body {
		font: 300 16px "Helvetica Neue";
		height: 640px;
		margin: 80px 160px 80px 160px;
		position: relative;
		width: 960px;
		overflow:hidden;
	}
	
	.chart{
		margin-left:-175px;
		margin-top:-50px;
	}
	
	.axis{
		shape-rendering: crispEdges;
	}
	
	.axis path, .axis line{
		fill: none;
	}
	
	.x.axis path{
		stroke: #fff;
	}
	.x.axis line{
		stroke: #ddd;
		stroke-opacity: .5
	}
	
	rect.pane {
		cursor: move;
  		fill: none;
  		pointer-events: all;
	}
	
	.brush .extent {
  		fill-opacity: .200;
  		shape-rendering: crispEdges;
	}

	</style>
</head>
<body>
	<script>
	var temp;
		function renderTimeLine(){
		var group, barGroup, context, scruboffset = 0, scrubData;
			
		var m = [80, 160, 0, 80]; // top right bottom left
		var m2 = [570, 160, 20, 80];
		var	w = 1200 - m[1] - m[3]; // width
		var h = 700 - m[0] - m[2]; // height
		var h2 = 700 - m2[0] - m2[2];
		
		
		
			var data = [{"label": "chlorthalidone", "dates":[{"startdate": new Date(2007,9,01), "enddate": new Date(), "strength": 16, "dosage": 25}]},
			{"label": "metformin", "dates":[{"startdate": new Date(2008,7,27), "enddate": new Date(2009,1,27), "strength": 1, "dosage": 500}, {"startdate":new Date(2009,1,28), "enddate": new Date(2011,8,07), "strength": 16, "dosage": 1000 }]},
			{"label": "citalopram", "dates":[{"startdate": new Date(2008,7,27), "enddate": new Date(2008,10,24), "strength": 1, "dosage": 10}, {"startdate": new Date(2008,10,25), "enddate": new Date(2008,12,23), "strength": 8, "dosage": 20}, {"startdate":new Date(2008,12,24), "enddate": new Date(2009,6,21), "strength": 16, "dosage": 40}, {"startdate": new Date(2009,6,22), "enddate": new Date(2010,3,18), "strength": 8, "dosage": 20}]},
			{"label": "clonazepam", "dates": [{"startdate": new Date(2008,11,02), "enddate": new Date(2009,3,31), "strength": 1, "dosage": 0.5}]},
			{"label": "trazodone", "dates": [{"startdate": new Date(2009,4,02), "enddate": new Date(2009,5,30), "strength": 1, "dosage": 50}, {"startdate": new Date(2009,6,01), "enddate": new Date(2009,11,26), "strength": 16, "dosage": 100}, {"startdate": new Date(2009,11,27), "enddate": new Date(2010,3,26), "strength": 1, "dosage": 50}, {"startdate": new Date(2010,7,25), "enddate": new Date(2011,8,18), "strength": 1, "dosage": 50}]},
			{"label": "zolpidem", "dates":[{"startdate": new Date(2010,3,27), "enddate": new Date(2010,7,24), "strength": 1, "dosage": 10}]},
			{"label": "lisonopril", "dates":[{"startdate": new Date(2010,7,24), "enddate": new Date(2011,3,20), "strength": 1, "dosage": 10}, {"startdate": new Date(2011,3,21), "enddate": new Date(), "strength": 16, "dosage": 20}]},
			{"label": "naproxen", "dates":[{"startdate": new Date(2008,3,13), "enddate": new Date(2014,9,06), "strength": 1, "dosage": 500}]}
			];
			
			var x=d3.time.scale().range([125, w + 160]);
			var x2 = d3.time.scale().range([125, w + 160]);
			
			var minDate=new Date(2006,1,01);
			var maxDate=new Date(2016,1,01);
			
			var lDate = new Date();
			var rDate = new Date()
			
			var chartStart=100;
			
			x.domain([minDate, maxDate]);
			x2.domain([minDate, maxDate]);				
			
			var y=d3.scale.linear().domain([0, data.length]).range([chartStart, h]);
			var y2 = d3.scale.linear().domain([0, data.length]).range([0, 48]);
			
			var zoom = d3.behavior.zoom()
						.scaleExtent([.7, 1.3])
						.on("zoom", zoomed);
						
			var brush = d3.svg.brush()
						.x(x2)
						.extent([(lDate.setMonth(lDate.getMonth() - 2)), (rDate.setMonth(rDate.getMonth() + 1))])
						.on("brush", brushed);
						
			var drag = d3.behavior.drag()
						.on("dragstart",scrubstart)
    					.on("drag", scrub);
					
			
			var chart=d3.select('body').append("svg")
					.classed("chart", true)
					.attr("width", w+m[1])
					.attr("height",h+m[0]+m[2]);
						
							
			var xaxis=d3.svg.axis()
					.scale(x)
					.orient("top")
					.tickSize(h-75)
					.tickPadding(3);
					
			var xaxis2 = d3.svg.axis()
							.scale(x2)
							.orient("bottom")
							.tickPadding(0)
							.tickSize(0);
			
			chart.append("g").attr("class", "x axis")
				.attr("transform", "translate(0, "+ (h-20) + ")")
				.attr("font-size", "15px")
				.call(xaxis);
				
		var timeBars=chart.selectAll(".medicineGroup").data(data).enter().append('g').classed("medicineGroup", true)
							.attr('transform', function(d, i){ return 'translate(0, '+ (y(i)) +')' }) ;
							
		function updateBars(){
			timeBars.each(function(d, i){
				//console.log(d);
		 		group=d3.select(this);
		 		
		 		group.select(".barGroup").selectAll(".timeBars").each(function(d){
		 			d3.select(this)
		 			.attr("x", function(d){ return x(d.startdate);})
					.attr("width", function(d){ return x(d.enddate)-x(d.startdate);})
				
		 		});
		 			
		 	});
		}	
		
						
		timeBars.each(function(d, i){
			//console.log(d);
		 	group=d3.select(this);
		 
			barGroup = group.append("g").classed("barGroup", true);
		 
			barGroup.selectAll(".timeBars")
				.data(d.dates)
				.enter()
				.append("rect")
				.classed("timeBars", true)
				.attr("y", -7)
				.attr("height", 20)
				.attr("stroke", "white")
				.attr("fill", function(d){
					if(d.strength<8){
						return "lightgrey";
					}else if(d.strength>=8 && d.strength<16){
						return "grey";
					}else{
						return "black";
					}
				});
				
			group.append("rect")
				.attr("x", 0)
				.attr("y", -40)
				.attr("width", 125)
				.attr("height", h)
				.attr("stroke", "white")
				.attr("fill", "white");
			
			group.append("text")
				.attr("y", 5)
				.attr("x",25)
				.attr("height", 100)
				.attr("stroke", "none")
				.attr("fill", "black")
				.attr("text-anchor", "start")
				.attr("dominant-baseline", "middle")
				.attr("font-size","15px")
				.text(d.label);
				
		});
		
		chart.append("rect")
    		.attr("class", "pane")
    		.attr("x", 125)
    		.attr("width", w + 50)
    		.attr("y", 55)
    		.attr("height", h - 80)
    		.attr("stroke", "#EEEEEE")
    		.call(zoom);
            
        var scrubber=chart.append("g");
        
        scrubber.append("rect")
        	.attr("class", "scrubber")
        	.attr("x", w)
        	.attr("width", "1000px")
        	.attr("y", 55)
        	.attr("height", h-80)
        	.attr("fill", "#fefefe")
        	.attr("fill-opacity", .8 )
        	.attr("cursor", "move")
        	.attr("stroke", "#EEEEEE")
        	.attr("stroke-dasharray", [0, 800+(h-80)+800,h-80])
        	.call(drag);
        	
        chart.selectAll(".medicineGroup").each(function(d, i){
        	scrubber.append("g")
        	.attr("transform",this.attributes[1].value)
        	.append("text")
        		.attr("class","scrubDisplay")
	        	.attr("fill","#000000")
    	    	.attr("width","100px")
    	    	.attr("x",w+50)
    	    	.attr("y", 7)
        		.attr("height","20px")
        		.attr("font-size", "12px");
		});
        	
        function scrubstart(d){
        	//scruboffset = d3.event.sourceEvent.x-(1*scrubber.select(".scrubber").attr("x"));
        	//console.log(d3.event);
        	scruboffset = 0;
        }
        	
        function scrub(d){
        	if(d3.event.x-scruboffset >= 1080)
        		scrubber.select(".scrubber").attr("x", 1080);
        	else if(d3.event.x-scruboffset <= 125)
        		scrubber.select(".scrubber").attr("x", 125);
        	else
        		scrubber.select(".scrubber").attr("x", d3.event.x-scruboffset);
        	
        	updateOnScrub();
        }
        
        function updateOnScrub(){
        
        	var ind = 0;
        	scrubber.selectAll(".scrubDisplay").each(function(d){
        		d3.select(this).attr("x",scrubber.select(".scrubber").attr("x")*1 + 20)
        			.attr("fill","none");
				for(var i = 0; i < data[ind].dates.length; i++)
				{
					
        			if((x.invert(1*scrubber.select(".scrubber").attr("x")) < data[ind].dates[i].enddate) && 
        				(x.invert(1*scrubber.select(".scrubber").attr("x")) > data[ind].dates[i].startdate))
        			{
        				 d3.select(this).attr("fill","#000000")
        				 	.text("" + data[ind].dates[i].dosage + " " + data[ind].label);
        			}
        		}
        		ind++;
        	});
        };
		

		context = chart.append("g")
					.attr("transform", "translate(0 , " + (m2[0]+ 30) + ")");
					
		context.append("rect")
				.attr("x", 125)
				.attr("width", w + 40)
				.attr("y", -5)
				.attr("height", 55)
				.attr("stroke", "#EEEEEE")
				.attr("fill", "none");
				
		var contextBars = context.selectAll(".medicineGroup").data(data)
								.enter().append("g")
								.classed("contextBar", true)
								.attr("transform", function(d, i){ return "translate(0, " + (y2(i)) + ")" ;});
								
		contextBars.each(function(d, i){
			
			var cGroup = d3.select(this);
			
			cGroup.selectAll(".contextBars")
					.data(d.dates)
					.enter()
					.append("rect")
					.classed("cBars", true)
					.attr("x", function(d){ return x2(d.startdate);})
					.attr("width", function(d){ return x2(d.enddate) - x2(d.startdate);})
					.attr("y", function(d){ return -(d.strength*.25-1);})
					.attr("height", function(d){ return d.strength*.25+1;})
					.attr("fill", function(d){
						if(d.strength <=8){
							return "lightgrey";
						}else{
							return "grey";
						}
					});
		})
			
		context.append("g")
				.attr("class", "x brush")
				.call(brush)
			.selectAll("rect")
				.attr("y", -4)
				.attr("height", 53);
				
		chart.append("rect")
    		.attr("x", 1119)
    		.attr("width", 1)
    		.attr("y", 55)
    		.attr("height", h-25)
    		.attr("stroke", "#EEEEEE");
		
		function zoomed(){
				console.log(d3.event);
				
				// if(d3.event.sourceEvent.webkitMovementX != 0)
// 				{
// 					
// 				}
// 				else
				//{
				if(d3.event.scale == 1)
				{
					var dir = -d3.event.translate[0]/25;
					var tx1 = x2(brush.extent()[0])+dir;
					var tx2 = x2(brush.extent()[1])+dir;
					//dir = d3.select(".extent").attr("x")*1+dir;
					
					if(tx1 < 125)
					{
						tx2 += 125-tx1;
						tx1 = 125;
					}
					
					if(tx2 > 1120)
					{
						tx1 += 1120-tx2;
						tx2 = 1120;
					}
					d3.select(".extent").attr("x",tx1);
					brush.extent([x2.invert(tx1),x2.invert(tx2)]);
					x.domain(brush.extent());
					brushed();

					zoom.translate([0,0]);
				}
				else
				{
					var zScale = d3.event.scale;
					var mid = (x2(brush.extent()[1])-x2(brush.extent()[0]))/2+x2(brush.extent()[0]);
					var zWidth = (x2(brush.extent()[1])-x2(brush.extent()[0]))*zScale;
					
					var ts1 = mid-zWidth/2;
					var ts2 = mid+zWidth/2;
					
					//console.log(x2(minDate.setMonth(minDate.getMonth()+1)));
					
					
					if(zWidth > x2(minDate.setMonth(minDate.getMonth()+1))-125)
					{
						if(ts1 < 125)
							ts1 = 125;
						
						if(ts2 > 1120)
							ts2 = 1120;
					
						d3.select(".extent").attr("x",ts1);
						d3.select(".extent").attr("width",zWidth);
					
						brush.extent([x2.invert(ts1),x2.invert(ts2)])
						x.domain(brush.extent());
						brushed();
					}
					minDate.setMonth(minDate.getMonth()-1);
					zoom.scale(1)	
				}
			}

			function brushed(){
				x.domain(brush.extent());
				barGroup.selectAll(".timeBars").attr("x", function(d){return  x(d.startdate);});
				barGroup.attr("width", 5);
				chart.select("g.x.axis").call(xaxis);
				updateBars();
				updateOnScrub();
				
			}
			brushed();
	}
	</script>
	
	<script> renderTimeLine(); </script>
</body>
</html>

