<!DOCTYPE html>
<html>
<head lang="en">
	<title> Timeline </title>
	<meta charset="utf-8">
	<script type="text/javascript" src="./d3.v3.min.js"></script>
	<!-- <script type="text/javascript" src="https://github.com/mbostock/d3/blob/master/src/behavior/zoom.js"></script> -->
	<style type"text/css">
	body {
		font: 300 16px "Helvetica Neue";
		height: 640px;
		margin: 80px 160px 80px 160px;
		position: relative;
		width: 960px;
		<!-- overflow:hidden; -->
	}
	
	.chart{
		margin-left:-175px;
		margin-top:-50px;
		width:1170;
		height:700;
		overflow-y: scroll;
		<!-- overflow: visible; -->
	}
	
	.axis{
		shape-rendering: crispEdges;
	}
	
	.axis path, .axis line{
		fill: none;
	}
	
	.x.axis path{
		stroke: #fff;
	}
	.x.axis line{
		stroke: #ddd;
		stroke-opacity: .5
	}
	
	rect.pane {
		cursor: move;
  		fill: #FDFCFC;
  		pointer-events: all;
	}
	
	.brush .extent {
  		fill-opacity: .200;
  		shape-rendering: crispEdges;
	}

	</style>
</head>
<body>
	<!-- <div id="timeline"></div> -->
	<script>
	var temp, temp1;
		function renderTimeLine(){
		var group, barGroup, context, scruboffset = 0, scrubData, t1;
			
		var m = [80, 160, 0, 80]; // top right bottom left
		var m2 = [570, 160, 20, 80];
		var	w = 1200 - m[1] - m[3]; // width
		var h = 700 - m[0] - m[2]; // height
		var h2 = 700 - m2[0] - m2[2];
		
		var monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sept", "Oct", "Nov", "Dec"];				//Array to display the current month on the TodayLine
		
		//Data array for the timeline
		var data = [{"label": "Terbinafine", "dates":[{"startdate": new Date(2013,7,30), "enddate": new Date(2013,10,19), "strength": 16, "dosage": 250}]},
					{"label": "Omeprazole", "dates":[{"startdate": new Date(2012,5,19), "enddate": new Date(2013,1,31), "strength": 16, "dosage": 40}, {"startdate": new Date(2013,3,07), "enddate": new Date(2013,11,22), "strength": 16, "dosage": 40}]},
					{"label": "Gabapentin", "dates":[{"startdate": new Date(2012,4,19), "enddate": new Date(2012,9,25), "strength": 1, "dosage": 300}, {"startdate": new Date(2012,9,25), "enddate": new Date(2012,12,28), "strength": 4, "dosage": 300}, {"startdate": new Date(2012,12,28), "enddate": new Date(2013,11,22), "strength": 8, "dosage": 600}]},
					{"label": "Zolpidem", "dates":[{"startdate": new Date(2012,3,15), "enddate": new Date(2013,9,22), "strength": 1, "dosage": 5}]},
					{"label": "QVAR 40", "dates":[{"startdate": new Date(2011,2,19), "enddate": new Date(2013,9,19), "strength": 1, "dosage": 4}]},
					{"label": "Prednisone", "dates":[{"startdate": new Date(2010,12,09), "enddate": new Date(2013,9,19), "strength": 16, "dosage": 20}]},
					{"label": "Carvedilol", "dates":[{"startdate": new Date(2010,7,12), "enddate": new Date(2010,10,29), "strength": 1, "dosage": 6}, {"startdate": new Date(2010,10,29), 
						"enddate": new Date(2011,5,02), "strength": 8, "dosage": 12.5}, {"startdate": new Date(2011,5,02), "enddate": new Date(2014,2,20), "strength": 16, "dosage": 25}]},
					{"label": "Simvastatin", "dates":[{"startdate": new Date(2010,3,19), "enddate": new Date(2010,7,02), "strength": 16, "dosage": 40}, {"startdate": new Date(2010,7,02), "enddate": new Date(2011,9,30), "strength": "max", "dosage": 80}, {"startdate": new Date(2011,9,30), "enddate": new Date(2013,9,30), "strength": 16, "dosage": 40}]},
					{"label": "Citalopram", "dates":[{"startdate": new Date(2009,11,23), "enddate": new Date(2010,2,05), "strength": 1, "dosage": 10}, {"startdate": new Date(2010,5,31), "enddate": new Date(2010,8,19), "strength": 1, "dosage": 10}, {"startdate":new Date(2010,8,19), "enddate": new Date(2010,11,22), "strength": 8, "dosage": 20}, {"startdate": new Date(2010,11,22), "enddate": new Date(2011,4,28), "strength": 16, "dosage": 40}, {"startdate": new Date(2011,4,28), "enddate": new Date(2013,11,22), "strength": 8, "dosage": 20}]},
					{"label": "Albuterol", "dates":[{"startdate": new Date(2012,1,12), "enddate": new Date(2013,11,22), "strength": 1, "dosage": 12}]},
					{"label": "Insulin", "dates":[{"startdate": new Date(2012,11,19), "enddate": new Date(2013,9,19), "strength": 8, "dosage": 28}]},
					{"label": "Naproxen", "dates":[{"startdate": new Date(2008,3,04), "enddate": new Date(2010,1,19), "strength": 4, "dosage": 250}, {"startdate": new Date(2010,1,19), 
						"enddate": new Date(2013,9,19), "strength": 16, "dosage": 500}]},
					{"label": "Metformin", "dates":[{"startdate": new Date(2008,3,04), "enddate": new Date(2009,6,04), "strength": 8, "dosage": 1000}, {"startdate":new Date(2009,6,04), "enddate": new Date(2013,9,19), "strength": 16, "dosage": 2000}]},
					{"label": "Aspirin", "dates":[{"startdate": new Date(2007,5,12), "enddate": new Date(2013,9,19), "strength": 16, "dosage": 81}]},
					{"label": "Chlorthalidone", "dates":[{"startdate": new Date(2006,9,19), "enddate": new Date(2013,9,19), "strength": 16, "dosage": 25}]},
					{"label": "Varenicline", "dates":[{"startdate": new Date(2013,2,22), "enddate": new Date(2013,2,25), "strength": 1, "dosage": 0.5}, {"startdate": new Date(2013,2,28), "enddate": new Date(2013,5,22), "strength": 16, "dosage": 1}]},
					{"label": "Nitroglycerine", "dates":[{"startdate": new Date(2012,7,04), "enddate": new Date(2013,7,04), "strength": 8, "dosage": 0.4}]},
					{"label": "Bupropion", "dates":[{"startdate": new Date(2012,4,19), "enddate": new Date(2012,5,14), "strength": 1, "dosage": 150}, {"startdate": new Date(2012,5,14), "enddate": new Date(2012,9,10), "strength": 16, "dosage": 300}]},
					{"label": "Esomeprazole", "dates":[{"startdate": new Date(2011,10,24), "enddate": new Date(2012,5,19), "strength": 16, "dosage": 40}]},
					{"label": "Lisonopril", "dates":[{"startdate": new Date(2011,9,26), "enddate": new Date(2011,12,12), "strength": 1, "dosage": 10}, {"startdate": new Date(2011,12,12), "enddate": new Date(2012,3,05), "strength": 16, "dosage": 20}]},
					{"label": "Warfarin", "dates":[{"startdate": new Date(2011,5,09), "enddate": new Date(2011,11,11), "strength": 8, "dosage": 5}]},
					{"label": "Trazodone", "dates": [{"startdate": new Date(2011,2,18), "enddate": new Date(2011,5,09), "strength": 1, "dosage": 50}, {"startdate": new Date(2011,5,09), "enddate": new Date(2011,8,12), "strength": 4, "dosage": 100}, {"startdate": new Date(2011,8,12), "enddate": new Date(2011,11,28), "strength": 8, "dosage": 50}, {"startdate": new Date(2011,8,28), "enddate": new Date(2012,3,12), "strength": 4, "dosage": 50}]},
					{"label": "Atorvastin", "dates":[{"startdate": new Date(2008,6,25), "enddate": new Date(2009,7,02), "strength": 1, "dosage": 20}, {"startdate": new Date(2009,7,02), "enddate": new Date(2010,3,08), "strength": 16, "dosage": 40}]},
					// {"label": "Clonazepam", "dates": [{"startdate": new Date(2011,2,04), "enddate": new Date(2013,5,3), "strength": 4, "dosage": 1}]},
					// {"label": "Sumatriptan", "dates":[{"startdate": new Date(2006,2,11), "enddate": new Date(2013,10,19), "strength": 16, "dosage": 100}]},
					// {"label": "Cymbalta", "dates":[{"startdate": new Date(2012,11,18), "enddate": new Date(2014,2,14), "strength": 16, "dosage": 60}]},
					// {"label": "Pravastatin", "dates":[{"startdate": new Date(2012,7,04), "enddate": new Date(2013,7,04), "strength": 8, "dosage": 40}]},
					// {"label": "Metoprolol", "dates":[{"startdate": new Date(2011,1,19), "enddate": new Date(2013,7,01), "strength": 1, "dosage": 50}]},
					// {"label": "Losartan", "dates":[{"startdate": new Date(2012,3,05), "enddate": new Date(2013,1,30), "strength": 1, "dosage": 50}, {"startdate": new Date(2013,1,30), "enddate": new Date(2013,10,28), "strength": 16, "dosage": 100}]},
					// {"label": "Norco", "dates":[{"startdate": new Date(2010,7,14), "enddate": new Date(2013,8,14), "strength": 8, "dosage": 325}]},
					// {"label": "Duloxetine", "dates":[{"startdate": new Date(2012,2,24), "enddate": new Date(2012,4,06), "strength": 16, "dosage": 60}]},
					];
		
		var x=d3.time.scale().range([126, w + 160]);		//X-axis 
		var x2 = d3.time.scale().range([126, w + 160]);		//X-axis in the scrubber region
			
		var startdates=[];									//Array to store the startdates
		var enddates=[];									//Array to store the enddates
		
		//This loop adds the startdates and enddates into the respective arrays	
		for(var i = 0; i < data.length; i++){
			for(var j = 0; j < data[i].dates.length; j++){
				startdates[startdates.length] = new Date(data[i].dates[j].startdate);
				enddates[enddates.length] = new Date(data[i].dates[j].enddate);
			}
		}
			
		var minDate = startdates[0];						//Variable to store the minimum Date
		var maxDate = enddates[0];							//Variable to store the maximum Date

		//Loop to find out the min and max Date
		for(var i = 1; i < startdates.length; i++){
			if(startdates[i] < minDate)
				minDate = startdates[i];
					
			if(enddates[i] > maxDate)
				maxDate = enddates[i];
		}
			
		minDate = new Date(minDate.getFullYear(),0,1);
		maxDate = new Date(maxDate.getFullYear()+1,0,1);
			
		var lDate = new Date();								//Variable to store the left date to set brush extent
		var rDate = new Date();								//Variable to store the right date to set brush extent 
			
		var currDate = new Date();							//Stores the current Date								
		
		//Setting the domain of the x-axis	
		x.domain([minDate, maxDate]);
		x2.domain([minDate, maxDate]);

		//Setting the Y-axis 	
		var y=d3.scale.linear().domain([0, data.length]).range([66, h-19]);
		var y2 = d3.scale.linear().domain([0, data.length]).range([0, 48]);
		
		//Declaring the zoom behavior	
		var zoom = d3.behavior.zoom()
					.scaleExtent([.7, 1.3])
					.on("zoom", zoomed);
					
		// var scroll=d3.behavior.zoom()
// 					.on()
		
		//Declaring the brush 				
		var brush = d3.svg.brush()
					.x(x2)
					.extent([(lDate.setMonth(lDate.getMonth() - 2)), (rDate.setMonth(rDate.getMonth() + 1))])
					.on("brush", brushed);
		
		//Declaring the drag for the scrubber				
		var drag = d3.behavior.drag()
					.on("dragstart",scrubstart)
    				.on("drag", scrub);
					
		//Creating the chart area	
		var chart=d3.select('body').append("svg")
					.classed("chart", true)
					.attr("width", w+m[1]+50)
					.attr("height",h+m[0]+m[2]);
		
		//Appending a rectangular pane to the chart area	
		var pane = chart.append("g");
		
		pane.append("rect")
    		.attr("class", "pane")
    		.attr("x", 126)
    		.attr("width", w + 50)
    		.attr("y", 55)
    		.attr("height", h - 80)
    		.attr("stroke", "#EEEEEE")
    		.attr("stroke-width", 2)
    		//.call(zoom);
		
		//Setting the x-axis				
		var xaxis=d3.svg.axis()
					.scale(x)
					.orient("top")
					.tickSize(h-80)
					.tickPadding(3);
					
		var xaxis2 = d3.svg.axis()
						.scale(x2)
						.orient("bottom")
						.tickPadding(3)
						.tickSize(1);
		
		//Append the x-axis to the chart
		chart.append("g").attr("class", "x axis")
				.attr("transform", "translate(0, "+ (h-25) + ")")
				.attr("font-size", "15px")
				.call(xaxis);

		//Variable to create the timeline bars 		
		var medicines=chart.selectAll(".medicineGroup").data(data).enter().append('g').classed("medicineGroup", true)
								.attr('transform', function(d, i){ return 'translate(0, '+ (y(i)) +')' }) ;
		
		//Selects each medicine group and draws the reactangle for each drug
		//based on the start date and end date in the data array and displays the
		//dosage of each drug for a given period of time							
		medicines.each(function(d, i){
		 	group=d3.select(this);
		 
			barGroup = group.append("g").classed("barGroup", true);				//Appends timeline bars and text to the bars		
			barGroup.selectAll(".timeBars")
				.data(d.dates)
				.enter()
				.append("rect")
				.classed("timeBars", true)
				.attr("y", -7)
				.attr("height", 20)
				.attr("stroke", "white")
				.attr("fill", function(d){
					if(d.strength==1){
						return "rgba(47,47,47,.125)";
					}else if(d.strength==4){
						return "rgba(47,47,47,.25)";
					}else if(d.strength == 8){
						return "rgba(47,47,47,.5)";
					}else if(d.strength == 16){
						return "rgba(47,47,47,1)";
					}else{
						return "rgba(195,0,0,1)";
					}
				})
				.attr("cursor", "move")
				.call(zoom);
				
			barGroup.selectAll(".timeBarstext")
					.data(d.dates)
					.enter()
					.append("text")
					.classed("timeBarstext", true)
					.attr("y", "7")
					.attr("fill", "white")
					.attr("text-anchor", "middle")
					.attr("font-size", "11px")
					.text(function(d){return d.dosage;});	
		});
		
		pane.call(zoom);
		
		//temp = x(currDate);

		var todayLine = chart.append("g");									//Appends a line indicatiin current date and month
		
		//Append triangle above the line
		todayLine.append("path")
				.attr("class", "todayTriangle")
				.attr("d", d3.svg.symbol().type("triangle-down"))
				.attr("transform", "translate(" + (x(currDate) - 182) + ", 59)")
				.attr("fill", "#999999");
					
			todayLine.append("line")
					.attr("class", "todayLine")
					.attr("y1", 62)
					.attr("y2", h-25)
					.attr("stroke", "#999999")
					.attr("stroke-width", 2);
					
		var day = currDate.getDate();
		var month = currDate.getMonth();
		var newDate = monthNames[month] + " " + day;						//Stores the current date and month 
		
		//Append text above the line			
		todayLine.append("text")
				.attr("class", "todayLineText")
				.attr("x", x(currDate)-25)
				.attr("width", 10)
				.attr("y", 30)
				.attr("height", 10)
				.attr("fill", "black")
				.attr("font-size", "11px")
				.text("Today" + " " + newDate);
        
        //Append the drug names on the y-axis
    	var yAxisLabel = chart.append("g");
    	
    	yAxisLabel.append("rect")
    			.attr("class", "yAxisRect")
    			.attr("x", 0)
				.attr("y", 53)
				.attr("width", 125)
				.attr("height", h+50)
				.attr("stroke", "white")
				.attr("fill", "white");
        
        medicines.each(function(d, i){
			yAxisLabel.append("text")
				.attr("class", "yAxisText")
				.attr("y", y(i))
				.attr("x",25)
				.attr("height", 100)
				.attr("stroke", "none")
				.attr("fill", "rgba(67,67,67,.5)")
				.attr("text-anchor", "start")
				.attr("font-size","12px")
				.text(d.label);
        });
        
        
        //Appends a draggable rectangle over the bars to display the names of the drugs
        //selected by the it while dragging     
        var scrubber=chart.append("g");									
        
        //Creates the draggable rectangle
        scrubber.append("rect")
        	.attr("class", "scrubber")
        	.attr("x", w)
        	.attr("width", "1000px")
        	.attr("y", 55)
        	.attr("height", h-80)
        	.attr("fill", "#ffffff")
        	.attr("fill-opacity", .9 )
        	.attr("cursor", "move")
        	.attr("stroke", "#EEEEEE")
        	.attr("stroke-width", 3)
        	.attr("stroke-dasharray", [0, 800+(h-80)+800,h-80])
        	.call(drag);
        
        //Appends text over the scrubber and initially makes them invisible	
        chart.selectAll(".medicineGroup").each(function(d, i){
        	scrubber.append("g")
        	.attr("transform",this.attributes[1].value)
        	.append("text")
        		.attr("class","scrubDisplay")
	        	.attr("fill","#000000")
    	    	.attr("width","100px")
    	    	.attr("x",w+50)
    	    	.attr("y", 7)
        		.attr("height","20px")
        		.attr("font-size", "12px");
		});
		
		//A vertical scroll bar to scroll the chart vertically
		var scrollBar=chart.append("g");			
		
		scrollBar.append("rect")
				.attr("class", "vScroller")
				.attr("x", 1112)
				.attr("width", 6)
				.attr("y", 55)
				.attr("height", 50)
				.attr("rx", 2)
				.attr("ry", 2)
				.attr("fill", "#AAA8A8");


		//Variable to append a mini version of the timeline to allow brushing to select
		//region one wants to view
		context = chart.append("g")
					.attr("transform", "translate(0 , " + (m2[0]+ 30) + ")");
		
		//Appends a rectangular region to display the mini timeline			
		context.append("rect")
				.attr("x", 126)
				.attr("width", w + 40)
				.attr("y", -5)
				.attr("height", 60)
				.attr("stroke", "#EEEEEE")
				.attr("stroke-width", 2)
				.attr("fill", "#F4F4F4");
		
		//Appends x-axis to the context area		
		context.append("g")
			.attr("class", "x axis")
			.attr("font-size", "10px")
			.attr("transform", "translate(0, " + (h2-55) + ")")
			.call(xaxis2);
		
		//Creates the timeline bars in the context area	
		var contextBars = context.selectAll(".medicineGroup").data(data)
								.enter().append("g")
								.classed("contextBar", true)
								.attr("transform", function(d, i){ return "translate(0, " + (y2(i)) + ")" ;});
		
		//Selects each medicine group and draws the reactangle for each drug
		//based on the start date and end date in the data array						
		contextBars.each(function(d, i){
			var cGroup = d3.select(this);
			
			cGroup.selectAll(".contextBars")
					.data(d.dates)
					.enter()
					.append("rect")
					.classed("cBars", true)
					.attr("x", function(d){ return x2(d.startdate);})
					.attr("width", function(d){ return x2(d.enddate) - x2(d.startdate);})
					.attr("y", -1)
					.attr("height", 3)
					.attr("stroke", "white")
					.attr("fill", function(d){
						if(d.strength <8){
							return "lightgrey";
						}else{
							return "grey";
						}
					});
		});
		
		
		//Appends a line indicating the current date in the context region
		context.append("line")
				.attr("class", "contextLine")
				.attr("x1", x2(currDate))
				.attr("x2", x2(currDate))
				.attr("y1", -4)
				.attr("y2", 54)
				.attr("stroke-width", 1.75)
				.attr("stroke", "black")
				.attr("stroke-opacity", .5);
		
		//Appends a brush over the context region	
		context.append("g")
				.attr("class", "x brush")
				.call(brush)
			.selectAll("rect")
				.attr("y", -4)
				.attr("height", 58);
				
		chart.append("rect")
    		.attr("x", 1119)
    		.attr("width", 1)
    		.attr("y", 55)
    		.attr("height", h-20)
    		.attr("stroke", "#EEEEEE");
    	
    	chart.append("rect")
    		.attr("x", 1120)
    		.attr("width", 50)
    		.attr("y", 53)
    		.attr("height", h-17)
    		.attr("fill", "white");

    	//This function updates the timeline bars when zooming or dragging based on the
    	//x-axis and redraws them	
    	function updateBars(){
			medicines.each(function(d, i){
		 		group=d3.select(this);
		 		
		 		group.select(".barGroup").selectAll(".timeBars").each(function(d){
		 			d3.select(this)
		 			.attr("x", function(d){ return x(d.startdate);})
					.attr("width", function(d){ return x(d.enddate)-x(d.startdate);})
				
		 		});
		 		
		 		//Displays the dosage over the bars based on the width of the bars. If width is less than 30px the text
		 		//is not displayed
		 		group.select(".barGroup").selectAll(".timeBarstext").each(function(d){
		 			d3.select(this).attr("x", function(d){return x(d.startdate)+(x(d.enddate)-x(d.startdate))-15;})
		 							.attr("fill", function(d){
		 								if((x(d.enddate) - x(d.startdate))< 30)
		 									return "none";
		 								else
		 									return "white";
		 							});
		 		});
		 			
		 	});
		}	
		
        //This function sets the scrub offset on start of drag	
        function scrubstart(d){
        	scruboffset = 0;
        }
        
        //This allows to move the scrubber over the bars and sets the extent to which it can
        //be dragged	
        function scrub(d){
        	//console.log(d3.event.dy);
        	if(d3.event.x-scruboffset >= 1080)
        		scrubber.select(".scrubber").attr("x", 1080);
        	else if(d3.event.x-scruboffset <= 125)
        		scrubber.select(".scrubber").attr("x", 125);
        	else
        		scrubber.select(".scrubber").attr("x", d3.event.x-scruboffset);
        	
        	//On dragging the scrubber updates the names of the drugs selected by it
        	updateOnScrub();
        }
        
        //Displays the drug names over the scrubber based on the time bars selected by it
        function updateOnScrub(){
        	var ind = 0;
        	scrubber.selectAll(".scrubDisplay").each(function(d,j){
        		
        		d3.select(this).attr("x",scrubber.select(".scrubber").attr("x")*1 + 20)
        			.attr("fill","none");
				for(var i = 0; i < data[ind].dates.length; i++)
				{
        			if((x.invert(1*scrubber.select(".scrubber").attr("x")) < data[ind].dates[i].enddate) && 
        				(x.invert(1*scrubber.select(".scrubber").attr("x")) > data[ind].dates[i].startdate))
        			{
        				
        				var scrubSelect;
        				scrubSelect=d3.select(this);
        				scrubSelect.attr("fill", "rgba(67,67,67,1)")
        				 	.text("" + data[ind].label + " " + data[ind].dates[i].dosage);
        			}
        		}
        		ind++;
        	});
        	
        	//Updating yAxis labels of the timeline
        	updateyLabels();
        };
        
        //Changes the color of the yAxis labels based on the bars selected by the scrubber to
        //indicate active and inactive medicines.
        function updateyLabels(){

        	var scrubberArray=[];				
        	scrubberArray=scrubber.selectAll(".scrubDisplay")[0];				//Adds the bars selected by the scrubber to this array
        	
        	var yLabelArray=d3.selectAll(".yAxisText")[0];						//Adds the yAxis text to this array

        	for(var k=0; k<scrubberArray.length; k++){
        					
        		if(scrubberArray[k].attributes[1].value == "rgba(67,67,67,1)"){
        			console.log("Change to visible" + k);
        			d3.select(yLabelArray[k]).attr("fill", "rgba(67,67,67,1)");
        		}else{
        			console.log("Shoot change " + k + "to grey");
        			d3.select(yLabelArray[k]).attr("fill", "rgba(67,67,67,.5)");
        		}
        	}
        };
		
		//Allows dragging the chart and zooming along the x-axis and based on the zoom/drag moves the brush
		//to indicate the region of the timeline that is in focus
		function zoomed(){
				//console.log(d3.event);
			
				if(d3.event.scale == 1)
				{
					
					if(d3.event.sourceEvent.webkitMovementX != null)
					{
						var dir = d3.event.sourceEvent.webkitMovementX*.2;
						var tx1 = x2(brush.extent()[0])+dir;
						var tx2 = x2(brush.extent()[1])+dir;
						//dir = d3.select(".extent").attr("x")*1+dir;
					
						if(tx1 < 127)
						{
							tx2 += 127-tx1;
							tx1 = 127;
						}
					
						if(tx2 > 1120)
						{
							tx1 += 1120-tx2;
							tx2 = 1120;
						}
						d3.select(".extent").attr("x",tx1);
						brush.extent([x2.invert(tx1),x2.invert(tx2)]);
						x.domain(brush.extent());
						brushed();

						//zoom.translate([0,0]);
					
					}
					else
					{
						var dir = -d3.event.translate[0]/25;
						var tx1 = x2(brush.extent()[0])+dir;
						var tx2 = x2(brush.extent()[1])+dir;
						//dir = d3.select(".extent").attr("x")*1+dir;
					
						if(tx1 < 127)
						{
							tx2 += 127-tx1;
							tx1 = 127;
						}
					
						if(tx2 > 1120)
						{
							tx1 += 1120-tx2;
							tx2 = 1120;
						}
						d3.select(".extent").attr("x",tx1);
						brush.extent([x2.invert(tx1),x2.invert(tx2)]);
						x.domain(brush.extent());
						brushed();

						zoom.translate([0,0]);
					}
				}
				else
				{
					var zScale = d3.event.scale;
					var mid = (x2(brush.extent()[1])-x2(brush.extent()[0]))/2+x2(brush.extent()[0]);
					var zWidth = (x2(brush.extent()[1])-x2(brush.extent()[0]))*zScale;
					
					var ts1 = mid-zWidth/2;
					var ts2 = mid+zWidth/2;
					
					//console.log(x2(minDate.setMonth(minDate.getMonth()+1)));
					
					
					if(zWidth > x2(minDate.setMonth(minDate.getMonth()+1))-126)
					{
						if(ts1 < 127)
							ts1 = 127;
						
						if(ts2 > 1120)
							ts2 = 1120;
					
						d3.select(".extent").attr("x",ts1);
						d3.select(".extent").attr("width",zWidth);
					
						brush.extent([x2.invert(ts1),x2.invert(ts2)])
						x.domain(brush.extent());
						brushed();
						updateBars();
					}
					minDate.setMonth(minDate.getMonth()-1);
					zoom.scale(1)	
				}
				
			}

			//Allows brushing over the mini timeline and helps selecting a particular
			//section of the timeline
			function brushed(){
				x.domain(brush.extent());
				barGroup.selectAll(".timeBars").attr("x", function(d){return  x(d.startdate);});
				barGroup.attr("width", 5);
				chart.select("g.x.axis").call(xaxis);
				updateBars();
				updateOnScrub();
				updateTodayLine();
			}
			brushed();
			
			//Redraws the today line when zooming/dragging the timeline
			function updateTodayLine(){
				d3.select(".todayTriangle").attr("transform", "translate("+ (x(currDate)) +", 59)")
				d3.select(".todayLine").attr("x1", x(currDate))
						.attr("x2", x(currDate));
						
				d3.select(".todayLineText").attr("x", x(currDate) - 25)
										.attr("width", 10);
			}
	}
	</script>
	
	<script> renderTimeLine(); </script>
</body>
</html>

